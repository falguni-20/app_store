generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             Int                @id @default(autoincrement())
  name           String
  email          String             @unique
  password       String
  createdAt      DateTime           @default(now())
  instituteRoles UserInstitute[]
  orgRoles       UserOrganization[]
}

model Organization {
  id         Int                @id @default(autoincrement())
  name       String
  createdAt  DateTime           @default(now())
  institutes Institute[]
  users      UserOrganization[]
}

model Institute {
  id             Int                     @id @default(autoincrement())
  name           String
  organizationId Int
  createdAt      DateTime                @default(now())
  organization   Organization            @relation(fields: [organizationId], references: [id])
  installedApps  InstituteInstalledApp[]
  users          UserInstitute[]

  @@index([organizationId])
}

model UserOrganization {
  id             Int          @id @default(autoincrement())
  userId         Int
  organizationId Int
  role           OrgRole
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([userId, organizationId])
}

model UserInstitute {
  id          Int           @id @default(autoincrement())
  userId      Int
  instituteId Int
  role        InstituteRole
  institute   Institute     @relation(fields: [instituteId], references: [id])
  user        User          @relation(fields: [userId], references: [id])

  @@unique([userId, instituteId])
}

model App {
  id                  Int                     @id @default(autoincrement())
  name                String
  description         String
  category            String
  launchUrl           String
  webhookUrl          String
  logoUrl             String?
  requiredPermissions Json
  createdAt           DateTime                @default(now())
  webhookSecret       String?
  installations       InstituteInstalledApp[]
}

model InstituteInstalledApp {
  id          Int          @id @default(autoincrement())
  instituteId Int
  appId       Int
  settings    Json
  installedAt DateTime     @default(now())
  installedBy Int
  enabled     Boolean      @default(true)
  app         App          @relation(fields: [appId], references: [id])
  institute   Institute    @relation(fields: [instituteId], references: [id])
  webhookLogs WebhookLog[]

  @@unique([instituteId, appId])
  @@index([instituteId])
  @@index([appId])
}

model WebhookLog {
  id           Int                   @id @default(autoincrement())
  instituteId  Int
  appId        Int
  payload      Json
  statusCode   Int
  receivedAt   DateTime              @default(now())
  instituteApp InstituteInstalledApp @relation(fields: [instituteId, appId], references: [instituteId, appId], onDelete: Cascade)

  @@index([instituteId])
  @@index([appId])
}

enum OrgRole {
  SUPER_ADMIN
  ORG_ADMIN
  USER
}

enum InstituteRole {
  INSTITUTE_ADMIN
  USER
}
